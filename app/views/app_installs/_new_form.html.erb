<%= simple_nested_form_for(@app_install, url: app_installs_path, html: {class: "form-horizontal"}) do |f| %>
  <% true || if @app_install.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@app_install.errors.count, "error") %> prohibited this install from being saved:</h2>

      <ul>
      <% @install.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <%= f.hidden_field :gallery_url %>
  <%= f.hidden_field :blueprint_id %>

  <fieldset>
    <button type="button" class="btn btn-default btn-lg pull-right" id="new_app_install_form_show_advanced_fields_button">
      <%= content_tag(:i, '', class: 'fa fa-code') %> Advanced install
    </button>
  </fieldset>

  <div id="new_app_install_form_default_details">
    <fieldset>
      <legend>URL</legend>
      <div class="form-group form-group-lg">
        <div class="col-sm-10 col-sm-offset-2">
          <%= content_tag(:div, (f.object.host_name + '.' + f.object.domain_name), class: "form-data") %>
        </div>
      </div>
    </fieldset>
  </div>

  <div id="new_app_install_form_advanced_fields">

    <fieldset>
      <legend>Engine</legend>
      <%= render partial: 'shared/gadgets/form_field_inline', locals: {field: {name: :engine_name, label: :name}, f: f} %>
    </fieldset>

    <fieldset>
      <legend>URL</legend>
      <div class="form-group form-group-lg">
        <div class="col-sm-4">
          <%= f.label :host_name, class: "control-label" %>
          <%= f.text_field :host_name, class: "form-control" %>
        </div>
        <div class="col-sm-8">
          <%= f.label :domain_name, class: "control-label" %>
          <%= f.text_field :domain_name, class: "form-control" %>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>HTTP protocol</legend>
      <div class="form-group form-group-lg">
        <div class="col-sm-12">
          <%= f.collection_radio_buttons :http_protocol, ['HTTPS only', 'HTTP only', 'HTTPS and HTTP'], :to_s, :to_s, item_wrapper_class: :radio_button_collection_item %>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Display</legend>
      <div class="form-group form-group-lg">
        <div class="col-sm-2">
          <%= f.label :name, class: "control-label" %>
        </div>
        <div class="col-sm-10">
          <%= f.text_field :display_name, class: "form-control" %>
        </div>
      </div>
      <div class="form-group form-group-lg">
        <div class="col-sm-2">
          <%= f.label :description, class: "control-label" %>
        </div>
        <div class="col-sm-10">
          <%= f.text_field :display_description, class: "form-control" %>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Icon</legend>
      <div class="form-group form-group-lg">
        <div class="col-sm-2">
          <div class='form-image-control'>
            <div class='form-image-centering'>
              <%= image_tag(f.object.software_definition_from_gallery['image_url'], class: 'form-engine-icon') %>
            </div>
          </div>
        </div>
        <div class="col-sm-10">
          <%= f.file_field :icon, class: 'form-control input-lg choose_file_form_control' %>
        </div>
      </div>
    </fieldset>


    <% if @app_install.app_install_env_variables.where(ask_at_build_time: :true).present? %>
      <fieldset>
        <legend>Optional environment variables</legend>
        <%= f.fields_for :app_install_env_variables do |ev| %>
          <% if ev.object.mandatory != "zzz" %>
            <div class="form-group form-group-lg">
              <div class="col-sm-2">
                <label class="text optional control-label"><%= ev.object.name.to_s.humanize %></label>
              </div>
              <div class="col-sm-10">
                <% tooltip = (ev.object.comment || ev.object.name.to_s.humanize) %>
                <%= ev.text_field :value, class: "form-control", data: {toggle: "tooltip"}, title: tooltip %>
                <%= ev.hidden_field :name %>
              </div>
            </div>
          <% end %>
        <% end %>
      </fieldset>
    <% end %>
  </div>

  <%= @app_install.app_install_env_variables.map(&:ask_at_build_time).include? true %>
  <%= @app_install.app_install_env_variables.where(ask_at_build_time: true).all.inspect %>

  <% if @app_install.app_install_env_variables.where(ask_at_build_time: true).present? %>
    <fieldset>
      <legend>Mandatory environment variables</legend>
      <%= f.fields_for :app_install_env_variables do |ev| %>
        <% if ev.object.mandatory != "zzz" %>
          <div class="form-group form-group-lg">
            <div class="col-sm-2">
              <label class="text optional control-label"><%= ev.object.name.to_s.humanize %></label>
            </div>
            <div class="col-sm-10">
              <% tooltip = (ev.object.comment || ev.object.name.to_s.humanize) %>
              <%= ev.text_field :value, class: "form-control", data: {toggle: "tooltip"}, title: tooltip %>
              <%= ev.hidden_field :name %>
            </div>
          </div>
        <% end %>
      <% end %>
    </fieldset>
  <% end %>

  <fieldset>
    <legend>License</legend>
    <div class="col-sm-10 col-sm-offset-2">
      <div class="form-group form-group-lg form-text-lg">
        <%= link_to f.object.license_name, f.object.license_sourceurl, target: "_blank" %> 
      </div>
    </div>
    <%= render partial: 'shared/gadgets/form_checkbox_inline', locals: {field: {name: :terms_and_conditions_accepted, label: 'Accept'}, f: f} %>
  </fieldset>
  <div class="actions top-gap">
    <%= link_to((content_tag(:i, "", class: "fa fa-times") + " Cancel"), installer_path, class: "btn btn-lg btn-warning trigger-response-modal") %>
    <%= button_tag(type: "submit", class: "btn btn-lg btn-primary trigger-response-modal pull-right") do %>
      <%= content_tag(:i, "", class: "fa fa-check") + " Install" %>
    <% end %>
  </div>

<% end %>

<!-- <br>
<button type="button" class="btn btn-default" data-toggle="modal" data-target="#waiting-for-response-modal">
  show waiting for response modal
</button> -->
